#BSUB -q bio
#BSUB -J jobfile
#BSUB -oo jobfile_%J.out
#BSUB -eo jobfile_%J.err
#BSUB -R "rusage[mem=1024] span[hosts=1]"
#BSUB -n 1

# load conda environment and modules
. /home/labs/bioservices/services/miniconda2/etc/profile.d/conda.sh;conda activate rarevar;module load samtools;module load bamtools;module load bedtools

# make dirs
mkdir filtered_bam_files/ bam_statistics/ /scRarevar_output/ log_files/ statistics_ouputs

# filter bam file by filter list
python /home/labs/bioservices/shared/rarevar/code/scripts/filter_bam.py /home/eligol/Documents/01_WIS/01_Rarevar/data/bam_files/SRR13239540/SRR13239450_htseq_gene_header.bam None --output_folder ./filtered_bam_files --name_suffix test_jobfile --threads 1

# add chr to chromosome names in bam files
samtools view -H test_jobfile_CBfiltered.bam | sed  -e '/SN:chr/!s/SN:\([0-9XY]*\)/SN:chr&/' -e '/SN:chrM/!s/SN:MT/SN:chrM&/' | samtools reheader - test_jobfile_CBfiltered.bam > test_jobfile_CBfiltered_chr.bam;samtools index test_jobfile_CBfiltered_chr.bam

# remove old bam files
rm test_jobfile_CBfiltered.bam test_jobfile_CBfiltered.bam.bai

# run ht-seq to filter non gene cites from bam
htseq-count -f bam -i gene_name -t gene -m union -s yes -o test_jobfile_htseq_gene.sam test_jobfile_CBfiltered_chr.bam /home/labs/bioservices/shared/rarevar/data/gencode.v37.annotation.gtf 3>&1 > test_jobfile_stranded_counts.txt

# add header to the bam file
samtools view -H test_jobfile_CBfiltered_chr.bam | cat - test_jobfile_htseq_gene.sam > test_jobfile_htseq_gene_header.sam

# remove sam file
rm test_jobfile_htseq_gene.sam

Run scrarevar program
python /home/labs/bioservices/shared/rarevar/code/scRNAvariants/scripts/scrnavariants.py test_jobfile_htseq_gene_header.bam /shareDB/iGenomes/Homo_sapiens/UCSC/hg38/Sequence/WholeGenomeFasta/genome.fa /scRarevar_output/ --log-file /log_files/log_test_jobfile_%J.txt --threads 1

Run statistics analysis program
python /home/labs/bioservices/shared/rarevar/code/scRNAvariants/scripts/make_statistics.py scRarevar_output/raw_stats.tsv scRarevar_output/raw_unmutated_stats.tsv --output_folder statistics_ouput/ --log-file scRarevar_log_file/log_statistics_test_jobfile.txt

Find intersections with SNP and edit databases
python /home/labs/bioservices/shared/rarevar/code/scRNAvariants/scripts/visul/make_venn.py statistics_ouput/ /home/labs/bioservices/shared/rarevar/data/edit_snp_DB/human/edit_rep.bed /home/labs/bioservices/shared/rarevar/data/edit_snp_DB/human/edit_nonrep.bed /home/labs/bioservices/shared/rarevar/data/edit_snp_DB/human/snp_chr_sorted.vcf

Find intersections with SNP and edit databases
python /home/labs/bioservices/shared/rarevar/code/scripts/filter_snp.py statistics_ouput/aggregated_intersect.tsv /home/labs/bioservices/shared/rarevar/data/trained_models/snp_classifier.joblib